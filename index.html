<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistem Absensi & Sertifikat - Kab. Ciamis</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- SweetAlert2 untuk Pop Up Keren -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
    
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f3f4f6; }
        .glass-effect {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        .loader {
            border: 3px solid #f3f3f3;
            border-radius: 50%;
            border-top: 3px solid #3b82f6;
            width: 20px;
            height: 20px;
            -webkit-animation: spin 1s linear infinite; /* Safari */
            animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body class="min-h-screen flex items-center justify-center p-4 bg-gradient-to-br from-blue-900 to-indigo-800">

    <div class="glass-effect w-full max-w-2xl p-8 rounded-2xl shadow-2xl relative overflow-hidden">
        <!-- Header -->
        <div class="text-center mb-8">
            <h1 class="text-3xl font-bold text-gray-800 tracking-tight">Daftar Hadir</h1>
            <h2 class="text-xl font-semibold text-blue-700 mt-1">Webinar Pendidikan Ciamis Belajar</h2>
            <div class="h-1 w-20 bg-blue-600 mx-auto mt-4 rounded-full"></div>
        </div>

        <!-- Section Pencarian -->
        <div id="searchSection" class="mb-6">
            <label class="block text-sm font-medium text-gray-700 mb-2">Cari Data Sekolah</label>
            <div class="flex gap-2">
                <input type="number" id="searchNPSN" placeholder="Masukkan NPSN (Cth: 20211111)" 
                    class="w-full px-4 py-3 rounded-lg border border-gray-300 focus:ring-2 focus:ring-blue-500 focus:border-transparent outline-none transition shadow-sm">
                <button onclick="cariData()" id="btnCari"
                    class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-3 rounded-lg font-semibold transition shadow-md flex items-center gap-2">
                    <span id="btnText">Cari</span>
                    <div id="loadingSearch" class="loader hidden"></div>
                </button>
            </div>
            <p class="text-xs text-gray-400 mt-1">*Masukkan NPSN untuk mengisi data otomatis.</p>
        </div>

        <!-- Section Form (Awalnya Hidden atau Disabled) -->
        <form id="attendanceForm" class="space-y-4 opacity-50 pointer-events-none transition-all duration-300" onsubmit="kirimData(event)">
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <!-- NPSN (Readonly) -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">NPSN</label>
                    <input type="text" id="npsn" name="npsn" required readonly 
                        class="w-full px-4 py-2 rounded-lg bg-gray-100 border border-gray-300 text-gray-500">
                </div>
                
                <!-- Nama Sekolah -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Nama Sekolah</label>
                    <input type="text" id="namaSekolah" name="namaSekolah" required 
                        class="w-full px-4 py-2 rounded-lg border border-gray-300 focus:ring-2 focus:ring-blue-500 outline-none">
                </div>
            </div>

            <!-- Nama Kegiatan & Tanggal -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Nama Kegiatan</label>
                    <select id="namaKegiatan" name="namaKegiatan" required 
                        class="w-full px-4 py-2 rounded-lg border border-gray-300 focus:ring-2 focus:ring-blue-500 outline-none bg-white">
                        <option value="">-- Pilih Kegiatan --</option>
                        <option value="Webinar Pendidikan Strategi TKA Matematika SD">Webinar Pendidikan Strategi TKA Matematika SD</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Tanggal Kegiatan</label>
                    <input type="date" id="tanggalKegiatan" name="tanggalKegiatan" required 
                        class="w-full px-4 py-2 rounded-lg border border-gray-300 focus:ring-2 focus:ring-blue-500 outline-none">
                </div>
            </div>

            <!-- Nama Guru -->
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Nama Guru</label>
                <input type="text" id="namaGuru" name="namaGuru" placeholder="Nama Lengkap & Gelar" required 
                    class="w-full px-4 py-2 rounded-lg border border-gray-300 focus:ring-2 focus:ring-blue-500 outline-none">
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <!-- Jabatan -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Jabatan</label>
                    <select id="jabatan" name="jabatan" required 
                        class="w-full px-4 py-2 rounded-lg border border-gray-300 focus:ring-2 focus:ring-blue-500 outline-none bg-white">
                        <option value="">-- Pilih Jabatan --</option>
                        <option value="Kepala Sekolah">Kepala Sekolah</option>
                        <option value="Guru Kelas">Guru Kelas</option>
                        <option value="Guru Mapel">Guru Mapel</option>
                        <option value="Operator">Operator Sekolah</option>
                        <option value="Tenaga Kependidikan">Tenaga Kependidikan</option>
                    </select>
                </div>

                <!-- Kehadiran -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Kehadiran</label>
                    <select id="kehadiran" name="kehadiran" required 
                        class="w-full px-4 py-2 rounded-lg border border-gray-300 focus:ring-2 focus:ring-blue-500 outline-none bg-white">
                        <option value="Hadir">Hadir</option>
                        <option value="Tidak Hadir">Tidak Hadir</option>
                    </select>
                </div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <!-- Kecamatan (Dropdown Ciamis) -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Kecamatan</label>
                    <select id="kecamatan" name="kecamatan" required 
                        class="w-full px-4 py-2 rounded-lg border border-gray-300 focus:ring-2 focus:ring-blue-500 outline-none bg-white">
                        <option value="">-- Pilih Kecamatan --</option>
                        <option value="Banjarsari">Banjarsari</option>
                        <option value="Banjaranyar">Banjaranyar</option>
                        <option value="Baregbeg">Baregbeg</option>
                        <option value="Ciamis">Ciamis</option>
                        <option value="Cidolog">Cidolog</option>
                        <option value="Cihaurbeuti">Cihaurbeuti</option>
                        <option value="Cijeungjing">Cijeungjing</option>
                        <option value="Cikoneng">Cikoneng</option>
                        <option value="Cimaragas">Cimaragas</option>
                        <option value="Cipaku">Cipaku</option>
                        <option value="Cisaga">Cisaga</option>
                        <option value="Jatinagara">Jatinagara</option>
                        <option value="Kawali">Kawali</option>
                        <option value="Lakbok">Lakbok</option>
                        <option value="Lumbung">Lumbung</option>
                        <option value="Pamarican">Pamarican</option>
                        <option value="Panawangan">Panawangan</option>
                        <option value="Panjalu">Panjalu</option>
                        <option value="Panumbangan">Panumbangan</option>
                        <option value="Purwadadi">Purwadadi</option>
                        <option value="Rajadesa">Rajadesa</option>
                        <option value="Rancah">Rancah</option>
                        <option value="Sadananya">Sadananya</option>
                        <option value="Sindangkasih">Sindangkasih</option>
                        <option value="Sukadana">Sukadana</option>
                        <option value="Sukamantri">Sukamantri</option>
                        <option value="Tambaksari">Tambaksari</option>
                    </select>
                </div>

                <!-- Kabupaten (Default Readonly) -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Kabupaten</label>
                    <input type="text" id="kabupaten" name="kabupaten" value="Ciamis" readonly 
                        class="w-full px-4 py-2 rounded-lg bg-gray-100 border border-gray-300 text-gray-500">
                </div>
            </div>

            <!-- Submit Button -->
            <div class="pt-4">
                <button type="submit" id="btnSubmit"
                    class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-3 rounded-lg shadow-lg transform transition hover:scale-[1.02] flex justify-center items-center gap-2">
                    <span>Kirim & Generate Sertifikat</span>
                    <div id="loadingSubmit" class="loader hidden border-white border-t-transparent"></div>
                </button>
            </div>
        </form>
    </div>

    <!-- SCRIPT LOGIC -->
    <script>
        // GANTI URL INI DENGAN URL DEPLOYMENT APPS SCRIPT ANDA
        const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbxBluPPxIYgFSyIvu1P1rpbg8DoX4JPAxTGjeUekUlYOVsBrMFiSLMkpfhkyAiFadnU/exec";

        const form = document.getElementById('attendanceForm');
        const inputNPSNSearch = document.getElementById('searchNPSN');
        const btnCari = document.getElementById('btnCari');
        const loadingSearch = document.getElementById('loadingSearch');
        const btnText = document.getElementById('btnText');

        // Fungsi Pencarian
        async function cariData() {
            const npsn = inputNPSNSearch.value;
            if(!npsn) {
                Swal.fire('Error', 'Silakan masukkan NPSN terlebih dahulu', 'warning');
                return;
            }

            // UI Loading
            btnCari.disabled = true;
            btnText.textContent = "Mencari...";
            loadingSearch.classList.remove('hidden');

            try {
                // Fetch Data
                const response = await fetch(`${SCRIPT_URL}?action=search&npsn=${npsn}`);
                const data = await response.json();

                if (data.status === 'found') {
                    // Data Ditemukan
                    Swal.fire({
                        icon: 'success',
                        title: 'Data Ditemukan!',
                        text: 'Data ditemukan silahkan periksa dan perbaiki data apabila ada kesalahan',
                        confirmButtonText: 'OK, Periksa Data',
                        confirmButtonColor: '#3085d6'
                    });

                    // Isi form dengan FULL DATA
                    isiForm(data.data);
                    bukaForm();
                    
                } else {
                    // Data Tidak Ditemukan -> Pop Up Manual
                    Swal.fire({
                        title: 'Data Tidak Ditemukan',
                        text: "NPSN belum terdaftar. Silakan isi data secara manual.",
                        icon: 'info',
                        showCancelButton: true,
                        confirmButtonColor: '#3085d6',
                        cancelButtonColor: '#d33',
                        confirmButtonText: 'Isi Manual',
                        cancelButtonText: 'Batal'
                    }).then((result) => {
                        if (result.isConfirmed) {
                            // Kosongkan form manual, tapi isi NPSN
                            const emptyData = { npsn: npsn };
                            isiForm(emptyData); 
                            bukaForm();
                            // Fokus ke input nama sekolah
                            setTimeout(() => document.getElementById('namaSekolah').focus(), 500);
                        }
                    });
                }

            } catch (error) {
                console.error(error);
                Swal.fire('Error', 'Gagal menghubungi server. Pastikan internet lancar.', 'error');
            } finally {
                // Reset UI Button
                btnCari.disabled = false;
                btnText.textContent = "Cari";
                loadingSearch.classList.add('hidden');
            }
        }

        // Fungsi mengisi semua field form
        function isiForm(data) {
            // Text Input
            document.getElementById('npsn').value = data.npsn || '';
            document.getElementById('namaSekolah').value = data.namaSekolah || '';
            document.getElementById('namaGuru').value = data.namaGuru || '';
            
            // Dropdowns (Helper function untuk set value)
            setDropdownValue('jabatan', data.jabatan);
            setDropdownValue('kecamatan', data.kecamatan);
            setDropdownValue('kehadiran', data.kehadiran);
            setDropdownValue('namaKegiatan', data.namaKegiatan);

            // Date Handling
            if(data.tanggalKegiatan) {
                // Format tanggal dari ISO string (GAS return) ke YYYY-MM-DD
                const dateObj = new Date(data.tanggalKegiatan);
                if(!isNaN(dateObj)) {
                    // Ambil bagian YYYY-MM-DD
                    document.getElementById('tanggalKegiatan').value = dateObj.toISOString().split('T')[0];
                }
            } else {
                document.getElementById('tanggalKegiatan').value = '';
            }
        }

        // Helper untuk set dropdown jika value ada di opsi
        function setDropdownValue(elementId, valueToSelect) {
            const select = document.getElementById(elementId);
            if (!valueToSelect) {
                select.selectedIndex = 0; // Reset ke default
                return;
            }
            
            let found = false;
            for(let i=0; i<select.options.length; i++) {
                if(select.options[i].value === valueToSelect) {
                    select.selectedIndex = i;
                    found = true;
                    break;
                }
            }
            
            // Jika value dari database tidak ada di opsi dropdown, reset ke 0 atau biarkan
            if(!found) select.selectedIndex = 0; 
        }

        function bukaForm() {
            form.classList.remove('opacity-50', 'pointer-events-none');
            form.classList.add('opacity-100');
        }

        // Fungsi Kirim Data
        async function kirimData(e) {
            e.preventDefault();

            const btnSubmit = document.getElementById('btnSubmit');
            const loadingSubmit = document.getElementById('loadingSubmit');
            
            // Ambil Data Form
            const formData = {
                npsn: document.getElementById('npsn').value,
                namaSekolah: document.getElementById('namaSekolah').value,
                namaKegiatan: document.getElementById('namaKegiatan').value,
                tanggalKegiatan: document.getElementById('tanggalKegiatan').value,
                namaGuru: document.getElementById('namaGuru').value,
                jabatan: document.getElementById('jabatan').value,
                kecamatan: document.getElementById('kecamatan').value,
                kabupaten: document.getElementById('kabupaten').value,
                kehadiran: document.getElementById('kehadiran').value
            };

            // Validasi sederhana
            if(!formData.namaSekolah || !formData.namaGuru || !formData.kecamatan || !formData.namaKegiatan || !formData.tanggalKegiatan) {
                Swal.fire('Peringatan', 'Mohon lengkapi semua data!', 'warning');
                return;
            }

            // UI Loading
            btnSubmit.disabled = true;
            btnSubmit.classList.add('opacity-70');
            loadingSubmit.classList.remove('hidden');

            try {
                const response = await fetch(SCRIPT_URL, {
                    method: 'POST',
                    body: JSON.stringify(formData),
                    mode: "no-cors",
                    headers: { 'Content-Type': 'text/plain;charset=utf-8' }
                });

                Swal.fire({
                    icon: 'success',
                    title: 'Berhasil!',
                    text: 'Data absensi telah disimpan/diperbarui.',
                    confirmButtonText: 'OK'
                }).then(() => {
                    form.reset();
                    form.classList.add('opacity-50', 'pointer-events-none');
                    document.getElementById('searchNPSN').value = '';
                });

            } catch (error) {
                console.error(error);
                Swal.fire('Gagal', 'Terjadi kesalahan saat menyimpan data.', 'error');
            } finally {
                btnSubmit.disabled = false;
                btnSubmit.classList.remove('opacity-70');
                loadingSubmit.classList.add('hidden');
            }
        }
    </script>
</body>
</html>