<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistem Absensi & Sertifikat - Kab. Ciamis</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- SweetAlert2 untuk Pop Up Keren -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <!-- jsPDF untuk Generate PDF -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&family=Playfair+Display:wght@700&display=swap" rel="stylesheet">
    
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f3f4f6; }
        .glass-effect {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        .loader {
            border: 3px solid #f3f3f3;
            border-radius: 50%;
            border-top: 3px solid #3b82f6;
            width: 20px;
            height: 20px;
            -webkit-animation: spin 1s linear infinite; /* Safari */
            animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body class="min-h-screen flex items-center justify-center p-4 bg-gradient-to-br from-blue-900 to-indigo-800">

    <div class="glass-effect w-full max-w-2xl p-8 rounded-2xl shadow-2xl relative overflow-hidden">
        <!-- Header -->
        <div class="text-center mb-8">
            <h1 class="text-3xl font-bold text-gray-800 tracking-tight">Daftar Hadir</h1>
            <h2 class="text-xl font-semibold text-blue-700 mt-1">Webinar Pendidikan Ciamis Belajar</h2>
            <div class="h-1 w-20 bg-blue-600 mx-auto mt-4 rounded-full"></div>
        </div>

        <!-- Section Pencarian -->
        <div id="searchSection" class="mb-6">
            <label class="block text-sm font-medium text-gray-700 mb-2">Cari Data Sekolah</label>
            <div class="flex gap-2">
                <input type="number" id="searchNPSN" placeholder="Masukkan NPSN (Cth: 20211111)" 
                    class="w-full px-4 py-3 rounded-lg border border-gray-300 focus:ring-2 focus:ring-blue-500 focus:border-transparent outline-none transition shadow-sm">
                <button onclick="cariData()" id="btnCari"
                    class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-3 rounded-lg font-semibold transition shadow-md flex items-center gap-2">
                    <span id="btnText">Cari</span>
                    <div id="loadingSearch" class="loader hidden"></div>
                </button>
            </div>
            <p class="text-xs text-gray-400 mt-1">*Masukkan NPSN untuk mengisi data otomatis.</p>
        </div>

        <!-- Section Form (Awalnya Hidden atau Disabled) -->
        <form id="attendanceForm" class="space-y-4 opacity-50 pointer-events-none transition-all duration-300" onsubmit="kirimData(event)">
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <!-- NPSN (Readonly) -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">NPSN</label>
                    <input type="text" id="npsn" name="npsn" required readonly 
                        class="w-full px-4 py-2 rounded-lg bg-gray-100 border border-gray-300 text-gray-500">
                </div>
                
                <!-- Nama Sekolah -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Nama Sekolah</label>
                    <input type="text" id="namaSekolah" name="namaSekolah" required 
                        class="w-full px-4 py-2 rounded-lg border border-gray-300 focus:ring-2 focus:ring-blue-500 outline-none">
                </div>
            </div>

            <!-- Nama Kegiatan & Tanggal -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Nama Kegiatan</label>
                    <select id="namaKegiatan" name="namaKegiatan" required 
                        class="w-full px-4 py-2 rounded-lg border border-gray-300 focus:ring-2 focus:ring-blue-500 outline-none bg-white">
                        <option value="">-- Pilih Kegiatan --</option>
                        <option value="Webinar Pendidikan Strategi TKA Matematika SD">Webinar Pendidikan Strategi TKA Matematika SD</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Tanggal Kegiatan</label>
                    <input type="date" id="tanggalKegiatan" name="tanggalKegiatan" required 
                        class="w-full px-4 py-2 rounded-lg border border-gray-300 focus:ring-2 focus:ring-blue-500 outline-none">
                </div>
            </div>

            <!-- Nama Guru -->
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Nama Guru</label>
                <input type="text" id="namaGuru" name="namaGuru" placeholder="Nama Lengkap & Gelar" required 
                    class="w-full px-4 py-2 rounded-lg border border-gray-300 focus:ring-2 focus:ring-blue-500 outline-none">
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <!-- Jabatan -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Jabatan</label>
                    <select id="jabatan" name="jabatan" required 
                        class="w-full px-4 py-2 rounded-lg border border-gray-300 focus:ring-2 focus:ring-blue-500 outline-none bg-white">
                        <option value="">-- Pilih Jabatan --</option>
                        <option value="Kepala Sekolah">Kepala Sekolah</option>
                        <option value="Guru Kelas">Guru Kelas</option>
                        <option value="Guru Mapel">Guru Mapel</option>
                        <option value="Operator">Operator Sekolah</option>
                        <option value="Tenaga Kependidikan">Tenaga Kependidikan</option>
                    </select>
                </div>

                <!-- Kehadiran -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Kehadiran</label>
                    <select id="kehadiran" name="kehadiran" required 
                        class="w-full px-4 py-2 rounded-lg border border-gray-300 focus:ring-2 focus:ring-blue-500 outline-none bg-white">
                        <option value="Hadir">Hadir</option>
                        <option value="Tidak Hadir">Tidak Hadir</option>
                    </select>
                </div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <!-- Kecamatan (Dropdown Ciamis) -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Kecamatan</label>
                    <select id="kecamatan" name="kecamatan" required 
                        class="w-full px-4 py-2 rounded-lg border border-gray-300 focus:ring-2 focus:ring-blue-500 outline-none bg-white">
                        <option value="">-- Pilih Kecamatan --</option>
                        <option value="Banjarsari">Banjarsari</option>
                        <option value="Banjaranyar">Banjaranyar</option>
                        <option value="Baregbeg">Baregbeg</option>
                        <option value="Ciamis">Ciamis</option>
                        <option value="Cidolog">Cidolog</option>
                        <option value="Cihaurbeuti">Cihaurbeuti</option>
                        <option value="Cijeungjing">Cijeungjing</option>
                        <option value="Cikoneng">Cikoneng</option>
                        <option value="Cimaragas">Cimaragas</option>
                        <option value="Cipaku">Cipaku</option>
                        <option value="Cisaga">Cisaga</option>
                        <option value="Jatinagara">Jatinagara</option>
                        <option value="Kawali">Kawali</option>
                        <option value="Lakbok">Lakbok</option>
                        <option value="Lumbung">Lumbung</option>
                        <option value="Pamarican">Pamarican</option>
                        <option value="Panawangan">Panawangan</option>
                        <option value="Panjalu">Panjalu</option>
                        <option value="Panumbangan">Panumbangan</option>
                        <option value="Purwadadi">Purwadadi</option>
                        <option value="Rajadesa">Rajadesa</option>
                        <option value="Rancah">Rancah</option>
                        <option value="Sadananya">Sadananya</option>
                        <option value="Sindangkasih">Sindangkasih</option>
                        <option value="Sukadana">Sukadana</option>
                        <option value="Sukamantri">Sukamantri</option>
                        <option value="Tambaksari">Tambaksari</option>
                    </select>
                </div>

                <!-- Kabupaten (Default Readonly) -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Kabupaten</label>
                    <input type="text" id="kabupaten" name="kabupaten" value="Ciamis" readonly 
                        class="w-full px-4 py-2 rounded-lg bg-gray-100 border border-gray-300 text-gray-500">
                </div>
            </div>

            <!-- Action Buttons -->
            <div class="pt-4 space-y-3">
                <!-- Text Instruksi Baru -->
                <p id="instructionText" class="text-sm text-center text-gray-600 italic mb-1">
                    Silahkan menyimpan daftar hadir dan untuk generate / unduh sertifikat
                </p>

                <button type="submit" id="btnSubmit"
                    class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-3 rounded-lg shadow-lg transform transition hover:scale-[1.02] flex justify-center items-center gap-2">
                    <span>Kirim & Simpan Data</span>
                    <div id="loadingSubmit" class="loader hidden border-white border-t-transparent"></div>
                </button>

                <!-- Tombol Download Sertifikat (Hidden by Default) -->
                <button type="button" id="btnDownload" onclick="generateSertifikat()"
                    class="hidden w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 rounded-lg shadow-lg transform transition hover:scale-[1.02] flex justify-center items-center gap-2">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                    </svg>
                    <span>Unduh Sertifikat</span>
                </button>
            </div>
        </form>
    </div>

    <!-- SCRIPT LOGIC -->
    <script>
        const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbxBluPPxIYgFSyIvu1P1rpbg8DoX4JPAxTGjeUekUlYOVsBrMFiSLMkpfhkyAiFadnU/exec";

        const form = document.getElementById('attendanceForm');
        const inputNPSNSearch = document.getElementById('searchNPSN');
        const btnCari = document.getElementById('btnCari');
        const loadingSearch = document.getElementById('loadingSearch');
        const btnText = document.getElementById('btnText');
        const btnDownload = document.getElementById('btnDownload');
        const btnSubmit = document.getElementById('btnSubmit');
        const instructionText = document.getElementById('instructionText');
        
        let lastFormData = {};

        // Helper untuk memuat gambar ke Data URI + mengambil dimensi aslinya
        async function getDataUri(url) {
            return new Promise((resolve) => {
                const img = new Image();
                img.crossOrigin = "Anonymous"; // Penting untuk gambar dari URL eksternal
                img.onload = function () {
                    const canvas = document.createElement('canvas');
                    canvas.width = this.naturalWidth;
                    canvas.height = this.naturalHeight;
                    canvas.getContext('2d').drawImage(this, 0, 0);
                    
                    // Return object lengkap dengan data base64 dan dimensi
                    resolve({
                        data: canvas.toDataURL('image/png'),
                        width: this.naturalWidth,
                        height: this.naturalHeight,
                        ratio: this.naturalWidth / this.naturalHeight // Aspek Rasio
                    });
                };
                img.onerror = function() {
                    console.error("Gagal memuat gambar: " + url);
                    resolve(null);
                };
                img.src = url;
            });
        }

        async function cariData() {
            const npsn = inputNPSNSearch.value;
            if(!npsn) {
                Swal.fire('Error', 'Silakan masukkan NPSN terlebih dahulu', 'warning');
                return;
            }

            btnCari.disabled = true;
            btnText.textContent = "Mencari...";
            loadingSearch.classList.remove('hidden');

            try {
                const response = await fetch(`${SCRIPT_URL}?action=search&npsn=${npsn}`);
                const data = await response.json();

                if (data.status === 'found') {
                    Swal.fire({
                        icon: 'success',
                        title: 'Data Ditemukan!',
                        text: 'Silahkan periksa dan perbaiki data apabila ada kesalahan.',
                        confirmButtonText: 'OK, Periksa Data',
                        confirmButtonColor: '#3085d6'
                    });
                    
                    isiForm(data.data);
                    
                    // Reset Tombol State ketika pencarian ulang berhasil
                    btnSubmit.classList.remove('hidden');
                    btnDownload.classList.add('hidden');
                    instructionText.classList.remove('hidden');
                    
                    bukaForm();
                } else {
                    Swal.fire({
                        title: 'Data Tidak Ditemukan',
                        text: "NPSN belum terdaftar. Silakan isi data secara manual.",
                        icon: 'info',
                        showCancelButton: true,
                        confirmButtonText: 'Isi Manual',
                        cancelButtonText: 'Batal'
                    }).then((result) => {
                        if (result.isConfirmed) {
                            isiForm({ npsn: npsn });
                            
                            // Reset Tombol State untuk manual
                            btnSubmit.classList.remove('hidden');
                            btnDownload.classList.add('hidden');
                            instructionText.classList.remove('hidden');
                            
                            bukaForm();
                            setTimeout(() => document.getElementById('namaSekolah').focus(), 500);
                        }
                    });
                }
            } catch (error) {
                console.error(error);
                Swal.fire('Error', 'Gagal menghubungi server.', 'error');
            } finally {
                btnCari.disabled = false;
                btnText.textContent = "Cari";
                loadingSearch.classList.add('hidden');
            }
        }

        function isiForm(data) {
            document.getElementById('npsn').value = data.npsn || '';
            document.getElementById('namaSekolah').value = data.namaSekolah || '';
            document.getElementById('namaGuru').value = data.namaGuru || '';
            setDropdownValue('jabatan', data.jabatan);
            setDropdownValue('kecamatan', data.kecamatan);
            setDropdownValue('kehadiran', data.kehadiran);
            setDropdownValue('namaKegiatan', data.namaKegiatan);

            if(data.tanggalKegiatan) {
                const dateObj = new Date(data.tanggalKegiatan);
                if(!isNaN(dateObj)) {
                    // PERBAIKAN DATE: Menggunakan method lokal (getFullYear dkk) alih-alih toISOString()
                    // Ini mencegah tanggal mundur 1 hari jika browser merubah UTC ke lokal
                    const year = dateObj.getFullYear();
                    const month = String(dateObj.getMonth() + 1).padStart(2, '0'); // Bulan mulai dari 0
                    const day = String(dateObj.getDate()).padStart(2, '0');
                    document.getElementById('tanggalKegiatan').value = `${year}-${month}-${day}`;
                }
            } else {
                document.getElementById('tanggalKegiatan').value = '';
            }
        }

        function setDropdownValue(elementId, valueToSelect) {
            const select = document.getElementById(elementId);
            if (!valueToSelect) { select.selectedIndex = 0; return; }
            let found = false;
            for(let i=0; i<select.options.length; i++) {
                if(select.options[i].value === valueToSelect) {
                    select.selectedIndex = i;
                    found = true;
                    break;
                }
            }
            if(!found) select.selectedIndex = 0; 
        }

        function bukaForm() {
            form.classList.remove('opacity-50', 'pointer-events-none');
            form.classList.add('opacity-100');
        }

        async function kirimData(e) {
            e.preventDefault();
            
            lastFormData = {
                npsn: document.getElementById('npsn').value,
                namaSekolah: document.getElementById('namaSekolah').value,
                namaKegiatan: document.getElementById('namaKegiatan').value,
                tanggalKegiatan: document.getElementById('tanggalKegiatan').value,
                namaGuru: document.getElementById('namaGuru').value,
                jabatan: document.getElementById('jabatan').value,
                kecamatan: document.getElementById('kecamatan').value,
                kabupaten: document.getElementById('kabupaten').value,
                kehadiran: document.getElementById('kehadiran').value
            };

            if(!lastFormData.namaSekolah || !lastFormData.namaGuru || !lastFormData.tanggalKegiatan) {
                Swal.fire('Peringatan', 'Mohon lengkapi data!', 'warning');
                return;
            }

            btnSubmit.disabled = true;
            btnSubmit.classList.add('opacity-70');
            loadingSubmit.classList.remove('hidden');
            btnDownload.classList.add('hidden'); 

            try {
                const response = await fetch(SCRIPT_URL, {
                    method: 'POST',
                    body: JSON.stringify(lastFormData),
                    mode: "no-cors",
                    headers: { 'Content-Type': 'text/plain;charset=utf-8' }
                });

                Swal.fire({
                    icon: 'success',
                    title: 'Berhasil!',
                    text: 'Data absensi tersimpan. Silakan unduh sertifikat Anda.',
                    confirmButtonText: 'Unduh Sertifikat',
                    showCancelButton: true,
                    cancelButtonText: 'Tutup'
                }).then((result) => {
                    if (result.isConfirmed) {
                        generateSertifikat();
                    }
                    // Tampilkan tombol download, sembunyikan tombol simpan
                    btnDownload.classList.remove('hidden');
                    btnSubmit.classList.add('hidden');
                    instructionText.classList.add('hidden');
                });

            } catch (error) {
                console.error(error);
                Swal.fire('Gagal', 'Terjadi kesalahan saat menyimpan data.', 'error');
            } finally {
                btnSubmit.disabled = false;
                btnSubmit.classList.remove('opacity-70');
                loadingSubmit.classList.add('hidden');
            }
        }

        // --- FUNGSI GENERATE SERTIFIKAT PDF (UPDATED) ---
        async function generateSertifikat() {
            const originalText = btnDownload.innerHTML;
            btnDownload.innerHTML = '<span class="animate-pulse">Memproses PDF...</span>';
            btnDownload.disabled = true;

            try {
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF({
                    orientation: 'landscape',
                    unit: 'mm',
                    format: 'a4'
                });

                const width = doc.internal.pageSize.getWidth();
                const height = doc.internal.pageSize.getHeight();

                // 1. Load Semua Gambar
                const bgUrl = "https://raw.githubusercontent.com/herisheroes/gln2026/refs/heads/main/back.png";
                const logoUrl = "https://raw.githubusercontent.com/herisheroes/gln2026/refs/heads/main/logo1.png";
                const tteUrl = "https://raw.githubusercontent.com/herisheroes/gln2026/refs/heads/main/ttekadis.png";

                const [bgObj, logoObj, tteObj] = await Promise.all([
                    getDataUri(bgUrl),
                    getDataUri(logoUrl),
                    getDataUri(tteUrl)
                ]);

                // 2. Pasang Background
                if (bgObj && bgObj.data) {
                    doc.addImage(bgObj.data, 'PNG', 0, 0, width, height);
                }

                // 3. Pasang Logo
                if (logoObj && logoObj.data) {
                    const targetWidth = 100; 
                    const targetHeight = targetWidth / logoObj.ratio;
                    
                    const xLogo = (width - targetWidth) / 2;
                    doc.addImage(logoObj.data, 'PNG', xLogo, 10, targetWidth, targetHeight);
                    
                    var yStart = 10 + targetHeight + 10; 
                } else {
                    var yStart = 40;
                }

                // 4. Judul Sertifikat
                doc.setFont("helvetica", "bold");
                doc.setFontSize(36);
                doc.setTextColor(30, 58, 138); 
                
                const yJudul = Math.max(yStart, 60); 
                doc.text("SERTIFIKAT", width / 2, yJudul, { align: "center" });

                // 5. Konten Utama
                doc.setFont("times", "normal");
                doc.setFontSize(14);
                doc.setTextColor(0, 0, 0);
                doc.text("Diberikan kepada:", width / 2, yJudul + 15, { align: "center" });

                // --- BAGIAN INI SUDAH DIUPDATE SESUAI REQUEST ---
                // Ganti NAMA GURU dengan NAMA SEKOLAH
                const mainName = lastFormData.namaSekolah || "Nama Sekolah";
                doc.setFont("times", "bolditalic");
                doc.setFontSize(32);
                doc.setTextColor(20, 20, 20);
                // Handle split nama sekolah jika kepanjangan
                const splitName = doc.splitTextToSize(mainName, 250);
                doc.text(splitName, width / 2, yJudul + 30, { align: "center" });

                // Ganti JABATAN/ROLE dengan NPSN
                const npsnText = `NPSN : ${lastFormData.npsn || "-"}`;
                doc.setFont("times", "normal");
                doc.setFontSize(18); // Sedikit lebih besar agar jelas
                doc.setTextColor(0, 0, 0);
                
                // Hitung posisi Y berdasarkan berapa baris nama sekolah (jika panjang)
                const nameHeight = (splitName.length - 1) * 10; 
                doc.text(npsnText, width / 2, yJudul + 45 + nameHeight, { align: "center" });
                // -----------------------------------------------

                // Atas Partisipasi
                doc.setFontSize(14);
                // Sesuaikan posisi ke bawah
                doc.text("Atas partisipasinya sebagai Peserta pada kegiatan:", width / 2, yJudul + 60 + nameHeight, { align: "center" });

                // Nama Kegiatan
                const kegiatan = lastFormData.namaKegiatan || "Webinar Pendidikan";
                doc.setFont("helvetica", "bold");
                doc.setFontSize(22);
                doc.setTextColor(30, 58, 138); 
                const splitTitle = doc.splitTextToSize(kegiatan, 220); 
                doc.text(splitTitle, width / 2, yJudul + 72 + nameHeight, { align: "center" });

                // 6. Tanggal & Tanda Tangan
                const tanggalRaw = lastFormData.tanggalKegiatan;
                const tanggalObj = new Date(tanggalRaw);
                const options = { day: 'numeric', month: 'long', year: 'numeric' };
                const tanggalIndo = tanggalObj.toLocaleDateString('id-ID', options);
                const ttdTempat = `Ciamis, ${tanggalIndo}`;
                
                const yPosBawah = height - 50; 

                // Tanggal
                doc.setFont("times", "normal");
                doc.setFontSize(14);
                doc.setTextColor(0, 0, 0);
                doc.text(ttdTempat, width / 2, yPosBawah, { align: "center" });

                // Gambar TTE Kadis (UKURAN DIPERBESAR)
                if (tteObj && tteObj.data) {
                    const tteW = 75; // DIPERBESAR dari 55 menjadi 75
                    const tteH = tteW / tteObj.ratio; 
                    const xTte = (width - tteW) / 2;
                    doc.addImage(tteObj.data, 'PNG', xTte, yPosBawah + 5, tteW, tteH);
                } else {
                    doc.text("(Tanda Tangan Elektronik)", width / 2, yPosBawah + 20, { align: "center" });
                }

                // Simpan File
                // Gunakan nama sekolah sebagai nama file
                const safeName = mainName.replace(/[^a-zA-Z0-9]/g, "_");
                doc.save(`Sertifikat_${safeName}_Ciamis.pdf`);

            } catch (e) {
                console.error(e);
                Swal.fire('Error', 'Gagal membuat PDF: ' + e.message, 'error');
            } finally {
                btnDownload.innerHTML = originalText;
                btnDownload.disabled = false;
            }
        }
    </script>
</body>
</html>
